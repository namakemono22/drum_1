<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ドラム</title>
<style>
  @keyframes shake-animation {
    0% {
        transform: translateY(0);
    }
    50% {
        transform: translateY(-5px);
    }
    100% {
        transform: translateY(0);
    }
  }
  .shaking {
    animation: shake-animation 0.05s ease-out;
  }
  :root {
   --img-size: 20%;
  }
  #drams {
    position: relative;
  }
  .dram {
    width: var(--img-size);
    height: auto;
    position: absolute;
  }
  #floor_img { top: 300px; left: 550px; }
  #cymbal_img { top: 20px; left: 230px; }
  #ride_img { top: 90px; left: 560px; }
  #bass_img { top: 260px; left: 380px; }
  #tam_img { width: 15%; height: auto; top: 150px; left: 400px; }
  #snare_img { top: 250px; left: 300px; }
  #hi_hat_img { top: 160px; left: 160px; }
  .volume-control {
    display: flex;
    align-items: center;
  }
  .volume-slider {
    width: 100px;
    margin-left: 10px;
  }
  #start-button {
    margin: 20px;
    padding: 10px 20px;
    font-size: 16px;
    cursor: pointer;
  }
</style>
<script>
  let audioContext;
  let buffers = {};

  function initAudio() {
    // AudioContextがまだ作成されていない場合に作成
    if (!audioContext) {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      loadAudioFiles();
    }
  }

  function loadAudioFiles() {
    const audioFiles = {
      bass: 'bass.wav',
      hi_hat: 'hi_hat.wav',
      snare: 'snare.wav',
      tam: 'tam.wav',
      floor: 'floor.wav',
      cymbal: 'cymbal.wav',
      ride: 'ride.wav'
    };

    let promises = Object.keys(audioFiles).map(key => {
      return fetch(audioFiles[key])
        .then(response => response.arrayBuffer())
        .then(data => audioContext.decodeAudioData(data))
        .then(buffer => {
          buffers[key] = buffer;
        });
    });

    Promise.all(promises).then(() => {
      console.log("音声ファイルが読み込まれました");
    });
  }

  function playSound(key) {
    if (buffers[key]) {
      let source = audioContext.createBufferSource();
      source.buffer = buffers[key];
      let gainNode = audioContext.createGain();
      gainNode.gain.value = document.getElementById("volume-slider").value;
      source.connect(gainNode);
      gainNode.connect(audioContext.destination);
      source.start(0);
    }
  }

  function adjustVolume() {
    let volume = document.getElementById("volume-slider").value;
    // 音量調整のため、すべての音源を再度設定する
    Object.values(buffers).forEach(buffer => {
      if (buffer) {
        let source = audioContext.createBufferSource();
        let gainNode = audioContext.createGain();
        gainNode.gain.value = volume;
        source.connect(gainNode);
        gainNode.connect(audioContext.destination);
      }
    });
  }

  // ボタンがクリックされたときに AudioContext を初期化
  document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('start-button').addEventListener('click', initAudio);
  });

  document.addEventListener("keydown", function(event) {
    // AudioContextが作成されていない場合は処理を中止
    if (!audioContext) {
      return;
    }
    
    const keyActions = {
      32: 'bass', 'b': 'bass', 'n': 'bass',
      'd': 'hi_hat', 's': 'hi_hat',
      'g': 'snare', 'h': 'snare',
      'y': 'tam', 'u': 'tam',
      'j': 'floor', 'k': 'floor',
      'r': 'cymbal', 't': 'cymbal',
      'i': 'ride', 'o': 'ride'
    };

    let key = event.keyCode || event.key;
    let soundKey = keyActions[key];
    if (soundKey) {
      playSound(soundKey);
      const image = document.getElementById(`${soundKey}_img`);
      image.classList.add('shaking');
      image.addEventListener('animationend', function() {
        image.classList.remove('shaking');
      }, { once: true });
    }
  });
</script>
</head>
<body>

<!-- 音量調整のためのスライダー -->
<div class="volume-control">
    <label for="volume-slider">音量:</label>
    <input type="range" min="0" max="1" step="0.1" value="0.5"
    class="volume-slider" id="volume-slider" onchange="adjustVolume()">
</div>

<!-- AudioContext の初期化ボタン -->
<button id="start-button">音声を有効にする</button>

<!-- ドラムの画像 -->
<div id="drams">
    <img class="dram" id="bass_img" src="バス1.png">
    <img class="dram" id="floor_img" src="フロア1.png">
    <img class="dram" id="tam_img" src="タム1.png">
    <img class="dram" id="snare_img" src="スネア1.png">
    <img class="dram" id="cymbal_img" src="シンバル1.png">
    <img class="dram" id="hi_hat_img" src="ハイハット1.png">
    <img class="dram" id="ride_img" src="ライド1.png">
</div>
</body>
</html>
